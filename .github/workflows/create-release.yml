# .github/workflows/create-release.yml

# 工作流名称
name: Create and Publish Release

# 触发条件：仅当一个符合 'v*.*.*' 格式的 tag被推送到仓库时运行
on:
  push:
    tags:
      - 'v*.*.*'

# 定义工作流中的任务
jobs:
  create-release:
    # 任务名称
    name: Create Release Package
    # 运行环境
    runs-on: ubuntu-latest

    # 任务步骤
    steps:
      # 第 1 步：检出仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 第 2 步：使用 git archive 创建发行包 (更稳定、更推荐)
      # git archive 会自动读取 .gitattributes 文件来排除不需要的文件
      - name: Create release archive
        run: git archive -o release.tar.gz --format=tar.gz HEAD
      
      # 第 3 步：创建带版本号的 Release
      - name: Create Versioned Release (e.g., v1.2.3)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          body: "Automated release for version ${{ github.ref_name }}."
          files: release.tar.gz
          prerelease: ${{ contains(github.ref, '-') }}

      # 第 4 步：更新 "latest" Release
      - name: Update Latest Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Build (matches ${{ github.ref_name }})"
          body: "This is the latest automated build, automatically updated to match version ${{ github.ref_name }}."
          files: release.tar.gz
          prerelease: false
