#!/bin/bash

# å½“ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡ºè„šæœ¬
set -e

### === è„šæœ¬æè¿° === ###
# åç§°ï¼š install.sh
# åŠŸèƒ½ï¼š å®‰è£… VpsScriptKit è„šæœ¬
# ä½œè€…ï¼š YourName
# åˆ›å»ºæ—¥æœŸï¼š2025-07-15
# è®¸å¯è¯ï¼šMIT

# --- é…ç½® ---
INSTALL_DIR="/opt/VpsScriptKit"
REPO="oliver556/VpsScriptKit"
# ç”¨æˆ·è®¸å¯åè®®åŒæ„
AGREEMENT_ACCEPTED="false"

# --- é¢œè‰²å®šä¹‰ ---
RESET="\033[0m"
RED_BOLD="\033[1;31m"
GREEN_BOLD="\033[1;32m"
YELLOW_BOLD="\033[1;33m"
BLUE_BOLD="\033[1;34m"

# --- å‡½æ•°å®šä¹‰ ---
# å‡½æ•°ï¼šé€€å‡ºè„šæœ¬å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
error_exit() {
    echo -e "${RED_BOLD}é”™è¯¯: $1${RESET}" >&2
    exit 1
}

# å‡½æ•°ï¼šæ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# å‡½æ•°ï¼šè·å–æœ€æ–°å‘è¡Œç‰ˆçš„ä¸‹è½½é“¾æ¥
# é€šè¿‡ echo å°†ç»“æœè¾“å‡ºï¼Œä»¥ä¾¿è¢«è°ƒç”¨è€…æ•è·
get_latest_release_url() {
    # âœ… å°†çŠ¶æ€ä¿¡æ¯è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯æµ(stderr)ï¼Œè¿™æ ·å®ƒå°±ä¸ä¼šè¢«å‘½ä»¤æ›¿æ¢æ•è·
    echo -e "${BLUE_BOLD}--> æ­£åœ¨æŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬...${RESET}" >&2
    
    # è°ƒç”¨ GitHub API è·å–æœ€æ–° Release çš„ä¿¡æ¯
    local LATEST_RELEASE_JSON
    LATEST_RELEASE_JSON=$(curl -sSL "https://api.github.com/repos/$REPO/releases/latest")
    
    # ä»è¿”å›çš„ JSON ä¸­è§£æå‡º .tar.gz æ–‡ä»¶çš„ä¸‹è½½é“¾æ¥
    local TARBALL_URL
    TARBALL_URL=$(echo "$LATEST_RELEASE_JSON" | grep "browser_download_url" | grep "\.tar\.gz" | cut -d '"' -f 4)

    # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–åˆ° URL
    if [ -z "$TARBALL_URL" ]; then
        error_exit "æ— æ³•æ‰¾åˆ°æœ€æ–°çš„å‘è¡Œç‰ˆä¸‹è½½é“¾æ¥ï¼è¯·æ£€æŸ¥ä»“åº“ Release é¡µé¢ã€‚"
    fi
    
    # å°†æ‰¾åˆ°çš„ URL ä½œä¸ºå‡½æ•°çš„å”¯ä¸€æ ‡å‡†è¾“å‡º
    echo "$TARBALL_URL"
}

# å‡½æ•°ï¼šä¸‹è½½å¹¶è§£å‹æŒ‡å®šçš„ URL
# @param $1: è¦ä¸‹è½½çš„å‹ç¼©åŒ… URL
download_and_extract() {
    local tarball_url="$1"

    echo -e "${BLUE_BOLD}--> æ­£åœ¨ä¸‹è½½å¹¶è§£å‹æ–‡ä»¶...${RESET}" >&2
    
    # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶æ¥å­˜æ”¾ä¸‹è½½çš„å‹ç¼©åŒ…
    local TMP_TARBALL
    TMP_TARBALL=$(mktemp)

    # ä½¿ç”¨ä¼ å…¥çš„ URL è¿›è¡Œä¸‹è½½
    curl -L "$tarball_url" -o "$TMP_TARBALL" || error_exit "ä¸‹è½½å‘è¡Œç‰ˆå‹ç¼©åŒ…å¤±è´¥ï¼"
    
    # åˆ›å»ºå®‰è£…ç›®å½•
    mkdir -p "$INSTALL_DIR" || error_exit "åˆ›å»ºå®‰è£…ç›®å½• $INSTALL_DIR å¤±è´¥ï¼"
    
    # è§£å‹åˆ°ç›®æ ‡ç›®å½• (æ³¨æ„ï¼šæ²¡æœ‰ --strip-components=1)
    tar -xzf "$TMP_TARBALL" -C "$INSTALL_DIR" || error_exit "è§£å‹æ–‡ä»¶å¤±è´¥ï¼"
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$TMP_TARBALL"
}


# --- ä¸»å®‰è£…å‡½æ•° ---
install_main() {
    clear

    # è¯¢é—®ç”¨æˆ·æ˜¯å¦åŒæ„åè®®
    confirm_agreement

    # âœ… å¦‚æœç”¨æˆ·ä¸åŒæ„ (å˜é‡ä»ä¸º "false")ï¼Œåˆ™é€€å‡ºå®‰è£…
    if [[ "$AGREEMENT_ACCEPTED" != "true" ]]; then
        echo
        echo -e "${RED_BOLD}æ‚¨å·²æ‹’ç»ç”¨æˆ·åè®®ï¼Œå®‰è£…å·²å–æ¶ˆã€‚${RESET}"
        rm -rf "$INSTALL_DIR"
        rm -rf "/usr/local/bin/vsk"
        rm -rf "/usr/local/bin/v"
        clear
        exit 1
    fi

    echo
    # 1. æ¸…ç†æ—§ç‰ˆæœ¬
    echo -e "${CYAN}ğŸ§¹ æ­£åœ¨æ¸…ç†æ—§ç‰ˆæœ¬...${RESET}"
    rm -rf "$INSTALL_DIR"
    rm -rf "/usr/local/bin/vsk"
    rm -rf "/usr/local/bin/v"
    sleep 1
    echo
    echo -e "${CYAN}âœ… è„šæœ¬å·²æ¸…ç†ï¼Œå³å°†è¦†ç›–å®‰è£…ï¼${RESET}"
    sleep 2
    clear

    echo -e "${GREEN_BOLD}æ­£åœ¨å®‰è£… VpsScriptKit...${RESET}"

    # 2. è°ƒç”¨å‡½æ•°è·å–æœ€æ–°å‘è¡Œç‰ˆçš„ä¸‹è½½é“¾æ¥
    local latest_url
    latest_url=$(get_latest_release_url)
    echo -e "--> æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå‡†å¤‡ä»ä»¥ä¸‹é“¾æ¥ä¸‹è½½:\n    $latest_url"

    # 3. è°ƒç”¨å‡½æ•°ä¸‹è½½å¹¶è§£å‹æ–‡ä»¶
    download_and_extract "$latest_url"

    # 4. è®¾ç½®æƒé™
    echo -e "${BLUE_BOLD}--> æ­£åœ¨è®¾ç½®æ–‡ä»¶æƒé™...${RESET}"
    find "$INSTALL_DIR" -type f -name "*.sh" -exec chmod +x {} +

    # 5. åˆ›å»ºå¿«é€Ÿå¯åŠ¨å‘½ä»¤
    echo -e "${BLUE_BOLD}--> æ­£åœ¨åˆ›å»ºå¿«é€Ÿå¯åŠ¨å‘½ä»¤...${RESET}"
    if [ -f "$INSTALL_DIR/vps_script_kit.sh" ]; then
        ln -sf "$INSTALL_DIR/vps_script_kit.sh" /usr/local/bin/v
        ln -sf "$INSTALL_DIR/vps_script_kit.sh" /usr/local/bin/vsk
    else
        echo -e "${YELLOW_BOLD}è­¦å‘Š: æœªåœ¨ä»“åº“æ ¹ç›®å½•æ‰¾åˆ° vps_script_kit.shï¼Œè·³è¿‡åˆ›å»ºå¿«æ·å‘½ä»¤ã€‚${RESET}"
    fi

    # 6. æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    clear
    # ä½¿ç”¨ cat å’Œ here-document æ¥æ‰“å° ASCII artï¼Œé¿å…å‰å¯¼ç©ºæ ¼
    cat <<-EOF
+----------------------------------------------------------------------------------------------------+
|  â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— |
|  â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â• |
|   â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    |
|    â–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â•â•â•â•â•â•â•â•šâ•â•â•â•â–ˆâ–ˆâ•‘  â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    |
|     â–ˆâ–ˆâ–ˆâ–ˆâ•—  â•‘â–ˆâ–ˆâ•‘       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘        â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    |
|     â•šâ•â•â•â•  â•šâ•â•â•       â•šâ•â•â•â•â•â•â•  â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•        â•šâ•â•     â•šâ•â•  â•šâ•â•â•šâ•â•   â•šâ•â•    |
+----------------------------------------------------------------------------------------------------+
EOF
    echo -e "${GREEN_BOLD}âœ… å®‰è£…å®Œæˆï¼${RESET} "
    echo -e "${GREEN_BOLD}   ç°åœ¨ä½ å¯ä»¥é€šè¿‡è¾“å…¥ ${YELLOW_BOLD}v${GREEN_BOLD} æˆ– ${YELLOW_BOLD}vsk${GREEN_BOLD} å‘½ä»¤æ¥å”¤å‡ºç®¡ç†èœå•ã€‚${RESET}"
    echo ""
}

# âœ… æ˜¾ç¤ºå¹¶ç¡®è®¤ç”¨æˆ·åè®®ã€‚åªè´Ÿè´£è¯¢é—®å¹¶è®¾ç½®å…¨å±€å˜é‡ï¼Œä¸è´Ÿè´£é€€å‡º
confirm_agreement() {
    clear
    echo -e "${BLUE}æ¬¢è¿ä½¿ç”¨ VpsScriptKit è„šæœ¬å·¥å…·ç®±${RESET}"
    echo -e "${YELLOW_BOLD}åœ¨ç»§ç»­å®‰è£…ä¹‹å‰ï¼Œè¯·å…ˆé˜…è¯»å¹¶åŒæ„ç”¨æˆ·åè®®ã€‚${RESET}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    # æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ›¿æ¢æˆæ‚¨çš„çœŸå®ç”¨æˆ·åè®®æ–‡æœ¬
	echo "ç”¨æˆ·è®¸å¯åè®®: https://"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    # è¯»å–ç”¨æˆ·è¾“å…¥
    local choice
    read -r -p "æ‚¨æ˜¯å¦åŒæ„ä»¥ä¸Šæ¡æ¬¾ï¼Ÿ(y/n): " choice
    echo

    # å°†è¾“å…¥è½¬æ¢ä¸ºå°å†™ä»¥ä¾¿æ¯”è¾ƒ
    choice=$(echo "$choice" | tr '[:upper:]' '[:lower:]')

    # å¦‚æœç”¨æˆ·åŒæ„ï¼Œå°†å…¨å±€å˜é‡è®¾ç½®ä¸º "true"
    if [[ "$choice" == "y" ]]; then
        # å¦‚æœç”¨æˆ·åŒæ„ï¼Œå°†å…¨å±€å˜é‡è®¾ç½®ä¸º "true"
        AGREEMENT_ACCEPTED="true"
        echo -e "${GREEN_BOLD}æ‚¨å·²åŒæ„ç”¨æˆ·åè®®ï¼Œå®‰è£…å°†ç»§ç»­...${RESET}"
    fi
}
# --- è„šæœ¬æ‰§è¡Œå…¥å£ ---

# æ£€æŸ¥ root æƒé™
if [ "$(id -u)" -ne 0 ]; then
    error_exit "æ­¤è„šæœ¬éœ€è¦ä»¥ root æƒé™è¿è¡Œã€‚è¯·ä½¿ç”¨ 'sudo bash $0' å†æ¬¡å°è¯•ã€‚"
fi

# æ£€æŸ¥ä¾èµ– (åªéœ€è¦ curl)
if ! command_exists "curl"; then
    error_exit "æ­¤è„šæœ¬éœ€è¦ 'curl' å‘½ä»¤ï¼Œä½†å®ƒæœªè¢«å®‰è£…ã€‚è¯·å…ˆå®‰è£…å®ƒã€‚"
fi

# è°ƒç”¨ä¸»å‡½æ•°
install_main
# user_license_agreement
